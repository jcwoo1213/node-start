<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container my-4">
  <!-- 로그인 / 로그아웃 버튼 -->
  <div class="d-flex justify-content-end mb-3">
    <button id="authBtn" class="btn btn-primary">
      로그인
    </button>
  </div>
    <div class="container my-4">
      <h3>Member List</h3>
      <table
        class="table table-striped table-bordered align-middle text-center"
      >
        <thead class="table-dark">
          <tr>
            <th scope="col">id</th>
            <th scope="col">이름</th>
            <th scope="col">이미지</th>
            <th scope="col">삭제</th>
          </tr>
        </thead>
        <tbody class="print_area">
          <tr>
            <td>1</td>
            <td>홍길동</td>
            <td></td>
          </tr>
          <tr>
            <td>2</td>
            <td>김철수</td>
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>
    <script>
      const role = localStorage.getItem("role");
      const name = localStorage.getItem("name");
      const txt= document.querySelector("h3");
      const btn =document.querySelector("#authBtn");
      if (role || name) {
        alert(`name=${name},role=${role}`);
        txt.innerHTML+=`<br/>${name}님의 권한은${role}입니다`;
        btn.innerText="로그아웃";
      }
      btn.addEventListener("click",(e)=>{
        if(role||name){
          localStorage.removeItem("name");
          localStorage.removeItem("role");
          alert("로그아웃 되었습니다");
          location.reload(true);
        }else{
          location.href="login.html";
        }
      })
      fetch("/getMember")
        .then((resp) => resp.json())
        .then((rows) => {
          const print_area = document.querySelector(".print_area");
          print_area.innerHTML = "";
          for (const member of rows) {
            // const tr = `<tr>
            //   <td>${member.user_id}</td>
            //   <td>${member.user_name}</td>
            //   <td>${
            //     member.user_img
            //       ? `<img
            //     src="/images/${member.user_img}"
            //     alt="${member.user_name}"
            //     class="img-thumbnail"
            //     width="80"
            //   />`
            //       : "없음"
            //   }</td>
            //   </tr>`;
            const tr = `<tr>
              <td>${member.user_id}</td>
              <td>${member.user_name}</td>
              <td><img
                src="/images/${member.user_img ? member.user_img : "default.jpg"}"
                alt="${member.user_name}"
                class="img-thumbnail"
                width="80"
              />
              </td>
              <td>
                <button type="button" class="btn btn-danger"data-user_id=${member.user_id} ${role!="Admin"? 'disabled':""}>삭제</button>
              </td>
            </tr>`;
            // ${role == "Admin" ? `<button type="button" class="btn btn-danger"data-user_id=${member.user_id} disabled>삭제</button>`: ""} ;
            print_area.innerHTML += tr;
          }
          const btns=document.querySelectorAll(".btn-danger");
          for (const btn of btns) {
            btn.addEventListener("click",(e)=>{
            const target=e.target.dataset.user_id;
            if(!confirm(`삭제할 아이디:${target} 정말로 삭제 하시겠습니까`)){
              return;
            }
            if(target==localStorage.getItem("id")){
              alert("현재 로그인 중인 계정입니다");
              return;
            }
            const file=(e.target.dataset.user_img?e.target.dataset.user_img:"");
            console.log(file);
            fetch(`/delete/${target}`,{
              method:"delete"
            })
            .then(resp=>resp.json())
            .then(res=>{
              if(res.retCode=="Success"){
                alert("삭제성공");
                location.reload(true);
              }else{
                alert("삭제실패");
                console.log(res.retMsg);
              }
            })
            .catch(err=>{
              console.log(err);
            })
          })
          }
        })
        .catch((err) => {
          console.log(err);
        });


    </script>
  </body>
</html>
